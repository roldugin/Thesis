%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Compiling this file will compile the entire document
%% from individual chapter files using `subfiles' package


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% PREAMBLE
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt,a4paper,twoside,final,british]{book}

\PassOptionsToPackage{usenames,dvipsnames}{xcolor}

\usepackage[british]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{luainputenc}
\usepackage{listings}
\usepackage{verbatim}
\usepackage{varioref}
\usepackage{refstyle}
\usepackage{textcomp}
\usepackage{amstext}
%\usepackage{graphicx}
\usepackage[margin=2cm]{geometry}
\usepackage[export]{adjustbox}
\usepackage{subfiles}
\usepackage{setspace}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{syntax}
\usepackage{xspace}
\usepackage[disable]{todonotes}
\usepackage{fixltx2e} % \textsubscript{} etc.


%% Packages included in this distribution
\usepackage{subsections}

\lstset{language=Haskell, columns=fixed, basewidth=.5em}

\renewcommand{\baselinestretch}{1.5}

\makeatletter

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LyX specific LaTeX commands.

\AtBeginDocument{\providecommand\subref[1]{\ref{sub:#1}}}
\DeclareRobustCommand{\greektext}{%
  \fontencoding{LGR}\selectfont\def\encodingdefault{LGR}}
\DeclareRobustCommand{\textgreek}[1]{\leavevmode{\greektext #1}}
\DeclareFontEncoding{LGR}{}{}
\DeclareTextSymbol{\~}{LGR}{126}
%% Because html converters don't know tabularnewline
\providecommand{\tabularnewline}{\\}
\RS@ifundefined{subref}
  {\def\RSsubtxt{section~}\newref{sub}{name = \RSsubtxt}}
  {}
\RS@ifundefined{thmref}
  {\def\RSthmtxt{theorem~}\newref{thm}{name = \RSthmtxt}}
  {}
\RS@ifundefined{lemref}
  {\def\RSlemtxt{lemma~}\newref{lem}{name = \RSlemtxt}}
  {}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%% END LyX specific LaTeX commands.

%\makeatother


%\input{itemize_md.tex}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Shorthand macros, environments, etc..
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\def\compose{$\circ$ }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Names and abbreviations

\newcommand\name[1]{\textsl{#1}\xspace}

\newcommand\LiveFusion{\name{LiveFusion}}
\newcommand\Loop{\name{Loop}}
\newcommand\C{\name{C}}
\newcommand\Haskell{\name{Haskell}}
\newcommand\GHC{\name{GHC}}
\newcommand\LLVM{\name{LLVM}}

%% The following shortcut does not work with caption for some reason
\newenvironment
  {cfigure}[1]
  {
    \def\TEMPCAPTION{#1}
    \begin{figure}
  }
  {
    \caption{\TEMPCAPTION}
    \end{figure}
  }


%%%%%%%%%%%%%%%%%%%%%%%%%%%% END Shortcuts.


%%%%%%%%%%%%%%%%%%%%%%%%%%%% Environments.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% C o d e   L i s t i n g s
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Credit: Much of this was borrowed from Trevor McDonell's thesis.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Styles

\lstset{%
    frame=none,
    rulecolor={\color[gray]{0.7}},
    numbers=none,
    basicstyle=\ttfamily,
    numberstyle=\color{Gray}\tiny\it,
    commentstyle=\color{MidnightBlue}\it,
    stringstyle=\color{Maroon},
    keywordstyle=[1],
    keywordstyle=[2]\color{ForestGreen},
    keywordstyle=[3]\color{Bittersweet},
    keywordstyle=[4]\color{RoyalPurple},
    captionpos=b,
    aboveskip=2\medskipamount,
    xleftmargin=0.5\parindent,
    xrightmargin=0.5\parindent,
    flexiblecolumns=false,
%   basewidth={0.5em,0.45em},           % default {0.6,0.45}
    escapechar={\%},
    texcl=true                          % tex comment lines
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Languages

\lstloadlanguages{Haskell}

\lstdefinestyle{haskell}{%
    language=Haskell,
    upquote=true,
    deletekeywords={case,class,data,default,deriving,do,in,instance,let,of,type,where},
    morekeywords={[2]class,data,default,deriving,family,instance,type,where},
    morekeywords={[3]in,let,case,of,do},
    literate=
        {\\}{{$\lambda$}}1
        {\\\\}{{\char`\\\char`\\}}1
        {>->}{>->}3
        {>>=}{>>=}3
        {->}{{$\rightarrow$}}2
        {>=}{{$\geq$}}2
        {<-}{{$\leftarrow$}}2
        {<=}{{$\leq$}}2
        {=>}{{$\Rightarrow$}}2
        {|}{{$\mid$}}1
        {forall}{{$\forall$}}1
        {exists}{{$\exists$}}1
        {...}{{$\cdots$}}3
%       {`}{{\`{}}}1
%       {\ .}{{$\circ$}}2
%       {\ .\ }{{$\circ$}}2
}

\lstdefinestyle{haskell-inline}{%
    style=haskell,
    basicstyle=\ttfamily,
    keywordstyle=[1],
    keywordstyle=[2],
    keywordstyle=[3],
    keywordstyle=[4],
    literate=
        {\\}{{$\lambda$}}1
        {\\\\}{{\char`\\\char`\\}}1
        {>->}{>->}3
        {>>=}{>>=}3
        {->}{{$\rightarrow$\space}}3    % include forced space
        {>=}{{$\geq$}}2
        {<-}{{$\leftarrow$}}2
        {<=}{{$\leq$}}2
        {=>}{{$\Rightarrow$}}2
        {|}{{$\mid$}}1
        {forall}{{$\forall$}}1
        {exists}{{$\exists$}}1
        {...}{{$\cdots$}}3
}

\lstdefinestyle{haskell-float}{%
    style=haskell,
%    frame=single,
%    numbers=left,
    float
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Shorthand for inline code fragments

\newcommand{\code}[1]{\lstinline[style=haskell-inline];#1;}
\newcommand{\footcode}[1]{\lstinline[style=haskell-inline];#1;}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Inline code typeset as @map f [1,2,3]@ or \inlc{map f [1,2,3]}
%% for some reason must reactivate @ after \begin{document}

\newcommand{\makeatcode}{\lstMakeShortInline[style=haskell-inline]@}
\newcommand{\makeatchar}{\lstDeleteShortInline@}


\makeatcode %% From now on code wrapped in @...@ will typeset as inline.
            %% Disable with \makeatchar

\newcommand{\app}{\ensuremath{\mathbin{\texttt{\char"40}}}}

\newcommand\inlc\lstinline

%% @ character must be made active *after* \begin{document} for some reason
\AtBeginDocument{\catcode`\@=\active}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% lstlisting environments for floating and fixed Haskell, C and Loop code

%% C code block without a figure box
\lstnewenvironment
  {ccode}[1]
  {\singlespacing\lstset{basicstyle={\ttfamily}, language=C, tabsize=4, #1}}
  {}

%% C code block with a figure box
\lstnewenvironment
  {ccode2}[2]
  {\singlespacing\lstset{style=basicstyle={\ttfamily}, language=C, tabsize=4, label=#1, caption=#2}}
  {}

%% Haskell code block without a figure box
\lstnewenvironment
  {hscode}
  {\singlespacing\lstset{style=haskell}}
  {}

%% Haskell code block with a figure box
\lstnewenvironment
  {hscode2}[1]
  {\singlespacing\lstset{style=haskell, caption=#1}}
  {}

%% Loop code block without a figure box
\lstnewenvironment
  {loopcode}
  {\singlespacing\lstset{style=haskell}}
  {}

%% Loop code block with a figure box
\lstnewenvironment
  {loopcode2}[2]
  {\singlespacing\lstset{style=haskell, float=htpb, label=#1, caption=#2}}
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Minimal syntax for supporting Markdown style \*italic*, \|fixed-width|, \$mathit$

\def\|#1|{\texttt{#1}}
\def\*#1*{\emph{#1}}
\def\$#1${$\mathit{#1}$}

%% Also \[body] for specifying loop block labels.
\def\[#1]{\texttt{#1}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Other

\newcommand\thesis\emph


%%%%%%%%%%%%%%%%%%%%%%%%%%%% END Environments.


\begin{document}

\subfile{main}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter 6: Loop representation: The Loop Language                         %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subfile{06-loops.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter 7: Code Generation and Haskell Backend                            %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subfile{07-backend.tex}

\end{document}
