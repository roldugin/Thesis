% !TEX TS-program = lualatex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Compiling this file will compile the entire document
%% from individual chapter files using `subfiles' package


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% PREAMBLE
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt,a4paper,twoside,final,british]{book}

\PassOptionsToPackage{usenames,dvipsnames}{xcolor}

\usepackage[british]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{luainputenc}
\usepackage{listings}
\usepackage{verbatim}
\usepackage{varioref}
\usepackage{refstyle}
\usepackage{textcomp}
\usepackage{amstext}
%\usepackage{graphicx}
\usepackage[margin=2cm]{geometry}
\usepackage[export]{adjustbox}
\usepackage{subfiles}
\usepackage{setspace}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{syntax}
\usepackage{xspace}
\usepackage[disable]{todonotes}
\usepackage{fixltx2e} % \textsubscript{} etc.
\usepackage{tcolorbox} % for rounded boxes around label names
\usepackage[tikz]{bclogo} % for highlighting important info in boxes
\usepackage{hyperref} % for clickable refs
\usepackage[toc,page]{appendix}

%% Packages included in this distribution
\usepackage{subsections}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% D o c u m e n t   f o r m a t t i n g
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\lstset{language=Haskell, columns=fixed, basewidth=.5em}

% 1.5 Line spacing between lines
\renewcommand{\baselinestretch}{1.5}

\makeatletter

% -1 part
%  0 chapter
%  1 section
%  2 subsection
%  3 subsubsection
%  4 subsubsubsection
\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{4}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Shorthand syntax, macros, environments, etc..
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\def\compose{$\circ$ }

% a round-about way of saying $_{#1}$ without the use of underscore
\newcommand\sub[1]{\textsubscript{$#1$}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Minimal syntax for supporting Markdown style \*italic*, \|fixed-width|, \$mathit$

\def\|#1|{\texttt{#1}}
\def\*#1*{\emph{#1}}
\def\$#1${$\mathit{#1}$}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Formatting block labels using \[bracket] syntax.

\definecolor{someblue}{rgb}{0.122, 0.435, 0.698}

\newtcbox{\roundedbox}{
  nobeforeafter,
  %colframe=someblue!50!white,
  colframe=someblue!10!white,
  colback=someblue!10!white,
  boxrule=0.5pt,
  arc=4pt,
  boxsep=0pt,
  left=5pt,
  right=5pt,
  top=5pt,
  bottom=5pt,
  tcbox raise base}

\def\lbl#1{\roundedbox{\texttt{#1}}}
\def\[#1]{\lbl{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Emphasising stuff

% Important info
\newcommand\thesis\emph


% Important info in a coloured box
\definecolor{bgblue}{RGB}{245,243,253}
\definecolor{ttblue}{RGB}{91,194,224}
\renewcommand\bcStyleTitre[1]{\large\bfseries\textcolor{black}{#1}} % used to be ttblue
\newenvironment{important}[1]
% before
{
    \begin{bclogo}[
        couleur=bgblue,
        arrondi=0,
        logo={\ }, %\bcbombe,
        barre=none,
        noborder=true]{#1}
}
% after
{
    \end{bclogo}
}

\newenvironment{bluebox}{%
    \noindent
    \adjustbox{
        innerenv={varwidth}[c]{\linewidth},
        margin=\fboxsep+.15cm \fboxsep+.2cm,
        bgcolor=someblue!20!white,
        center}
    \bgroup
}{%
    \egroup
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Names and abbreviations

\newcommand\term[1]{\textbf{#1}\xspace}
\newcommand\name[1]{\textsl{#1}\xspace}

\newcommand\LiveFusion{\name{LiveFusion}}
\newcommand\Loop{\name{Loop}}
\newcommand\C{\name{C}}
\newcommand\Haskell{\name{Haskell}}
\newcommand\GHC{\name{GHC}}
\newcommand\DPH{\name{DPH}}
\newcommand\LLVM{\name{LLVM}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Figure with caption at the bottom
\newenvironment
  {cfigure}[1]
  {
    \def\TEMPCAPTION{#1}
    \begin{figure}
  }
  {
    \caption{\TEMPCAPTION}
    \end{figure}
  }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Automatically make code after underscore subscripted

\def\SubscriptWord#1 {\check#1\relax\textsubscript{#1} }

% Check function parses world until space/newline
\def\check#1{%
\ifx\relax#1%
\else
\ifcat a#1%
\else
\typeout{illegal character #1}%
\fi
\expandafter\check
\fi}

% How to define \AutoSubscriptOn and \AutoSubscriptOff ??
%\def\AutoSubscriptOn{\def_{\SubscriptWord}}
% Hello_World will result in world subscripted World
% \_ will result in the usual underscore
%\edef\AutoSubscriptOff{\noexpand\def_{\_}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% C o d e   L i s t i n g s
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Credit: Much of this was borrowed from Trevor McDonell's thesis.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Styles
%% TODO: Perhaps add aboveskip, belowcaptionskip and belowskip

\lstset{%
    frame=none,
    rulecolor={\color[gray]{0.7}},
    numbers=none,
    basicstyle=\singlespacing\ttfamily,
    numberstyle=\color{Gray}\tiny\it,
    commentstyle=\color{MidnightBlue}\it,
    stringstyle=\color{Maroon},
    keywordstyle=[1],
    keywordstyle=[2]\color{ForestGreen},
    keywordstyle=[3]\color{Bittersweet},
    keywordstyle=[4]\color{RoyalPurple},
    captionpos=b,
%   aboveskip=2\medskipamount,          % this overrides \singlespacing ?
%   xleftmargin=0.5\parindent,
%   xrightmargin=0.5\parindent,
    flexiblecolumns=false,
%   basewidth={0.5em,0.45em},           % default {0.6,0.45}
    escapechar={\%},
    texcl=true                          % tex comment lines
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Languages

\lstloadlanguages{Haskell}

\lstdefinestyle{haskell}{%
    language=Haskell,
    upquote=true,
    deletekeywords={case,class,data,default,deriving,do,in,instance,let,of,type,where,if,then,else},
    morekeywords={[2]class,data,default,deriving,family,instance,type,where},
    morekeywords={[3]in,let,case,of,do,if,then,else},
    literate=
        {\\}{{$\lambda$}}1
        {\\\\}{{\char`\\\char`\\}}1
        {>->}{>->}3
        {>>=}{>>=}3
        {->}{{$\rightarrow$}}2
        {>=}{{$\geq$}}2
        {<-}{{$\leftarrow$}}2
        {<=}{{$\leq$}}2
        {=>}{{$\Rightarrow$}}2
        {|}{{$\mid$}}1
        {forall}{{$\forall$}}1
        {exists}{{$\exists$}}1
        {...}{{$\cdots$}}3
        {^}{{$^\uparrow$}}1 % WARNING: lifted function, not exponent
%       {`}{{\`{}}}1
%       {\ .}{{$\circ$}}2
%       {\ .\ }{{$\circ$}}2
}

\lstdefinestyle{haskell-inline}{%
    style=haskell,
    basicstyle=\ttfamily,
    keywordstyle=[1],
    keywordstyle=[2],
    keywordstyle=[3],
    keywordstyle=[4],
    literate=
        {\\}{{$\lambda$}}1
        {\\\\}{{\char`\\\char`\\}}1
        {>->}{>->}3
        {>>=}{>>=}3
        {->}{{$\rightarrow$\space}}3    % include forced space
        {>=}{{$\geq$}}2
        {<-}{{$\leftarrow$}}2
        {<=}{{$\leq$}}2
        {=>}{{$\Rightarrow$}}2
        {|}{{$\mid$}}1
        {forall}{{$\forall$}}1
        {exists}{{$\exists$}}1
        {...}{{$\cdots$}}3
        {^}{{$^\uparrow$}}1 % WARNING: lifted function, not exponent
}

\lstdefinestyle{haskell-float}{%
    style=haskell,
%    frame=single,
%    numbers=left,
    float
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Shorthand for inline code fragments

\newcommand{\code}[1]{\lstinline[style=haskell-inline];#1;}
\newcommand{\footcode}[1]{\lstinline[style=haskell-inline];#1;}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Inline code typeset as @map f [1,2,3]@ or \inlc{map f [1,2,3]}
%% for some reason must reactivate @ after \begin{document}

\newcommand{\makeatcode}{\lstMakeShortInline[style=haskell-inline]@}
\newcommand{\makeatchar}{\lstDeleteShortInline@}


\makeatcode %% From now on code wrapped in @...@ will typeset as inline.
            %% Disable with \makeatchar

\newcommand{\app}{\ensuremath{\mathbin{\texttt{\char"40}}}}

\newcommand\inlc\lstinline

%% @ character must be made active *after* \begin{document} for some reason
\AtBeginDocument{\catcode`\@=\active}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% lstlisting environments for floating and fixed Haskell, C and Loop code
%\input{loopcode}
\input{loopcode}

%% C code block without a figure box
\lstnewenvironment{ccode}
    {
        \minipage{\linewidth}
        \lstset{
            basicstyle=\singlespacing\ttfamily,
            language=C, 
            tabsize=4
        }
    }
    {
        \endminipage
    }

%% C code block with a figure box
\lstnewenvironment{ccode2}[1]
    {
        \lstset{
            basicstyle=\singlespacing\ttfamily,
            language=C,
            tabsize=4,
            float,
            #1
        }
    }
    {}

%% Haskell code block without a figure box
\lstnewenvironment{hscode}
    {
        \minipage{\linewidth}
        \lstset{style=haskell}
    }
    {
        \endminipage
    }

%% Haskell code block with a figure box
\lstnewenvironment{hscode2}[1]
    {\lstset{style=haskell-float, #1}}
    {}

%% Loop code block without a figure box
\lstnewenvironment{loopcode}[1][\unskip]
    {
        \minipage{\linewidth}
        \lstset{style=lfloop}
        #1
    }
    {
        \endminipage
    }

%% Loop code block with a figure box
\lstnewenvironment{loopcode2}[1]
    {\lstset{style=haskell-float, float=htpb, #1}}
    {}

% Sample usage of ccode2, hscode2 and loopcode2
% \begin{hscode2}{%
%  caption={The equation of everything.},%
%  label=lst:eqn-of-everythin}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% I n d e x
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Index
% ------------------------------------------------------------------------------

\makeindex
\providecommand{\indexe}[1]{\index{#1}\emph{#1}}
\providecommand{\indext}[1]{\index{#1}#1}

\providecommand{\iast}[1][]{\index{AST (abstract syntax tree)!#1}}
\providecommand{\iasg}[1][]{\index{ASG (abstract semantic graph)!#1}}
\providecommand{\ihoas}[1][]{\index{HOAS (higher-order abstract syntax)!#1}}
\providecommand{\idebruijn}[1][]{\index{De Bruijn!#1}}
\providecommand{\ith}[1][]{\index{Template Haskell!#1}}
\providecommand{\idph}[1][]{\index{DPH (Data Parallel Haskell)!#1}}
\providecommand{\ieqfusion}[1][]{\index{Equational fusion!#1}}
\providecommand{\iinl}[1][]{\index{inlining!#1}}
\providecommand{\irw}[1][]{\index{rewriting, term rewriting!#1}}
\providecommand{\irwrules}[1][]{\index{rewrite rule!#1}}
\providecommand{\ighc}[1][]{\index{GHC (Glasgow Haskell Compiler)!#1}}
\providecommand{\iloop}[1][]{\index{Loop EDSL!#1}}
\providecommand{\ifusion}[1][]{\index{fusion, loop fusion, array fusion!#1}}
\providecommand{\ilanguage}[1][]{\index{language!#1}}
\providecommand{\icollop}[1][]{\index{collective operation!#1}}
\providecommand{\isegd}[1][]{\index{segment descriptor!#1}}
\providecommand{\isegmented}[1][]{\index{segmented array combinator!#1}}
\providecommand{\ivect}[1][]{\index{vectoriser, vectorisation!#1}}
\providecommand{\icomb}[1][]{\index{combinator!#1}}
\providecommand{\iintermediate}[1][]{\index{intermediate value!#1}}
\providecommand{\irate}[1][]{\index{rate!#1}}
\providecommand{\ipe}[1][]{\index{processing element!#1}}
\providecommand{\iboxing}[1][]{\index{boxing!#1}}
\providecommand{\istreamfusion}[1][]{\index{Stream Fusion!#1}}
\providecommand{\iedsl}[1][]{\index{language: embedded!#1}}
\providecommand{\idsl}[1][]{\index{language: domain-specific!#1}}
\providecommand{\ihost}[1][]{\index{host program!#1}}
\providecommand{\iplugin}[1][]{\index{plugin!#1}}

\index{DSL|see {language: domain-specific}}
\index{EDSL|see {language: embedded}}
\index{deforestation|see {fusion}}
\index{unboxed values|see {boxing}}
\index{boxed values|see {boxing}}
\index{unboxing|see {boxing}}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% B i b l i o g r a p h y
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% How to conditionally insert bibliography:
% - In main.tex:
%   - put \def\CompilingAll{} after \begin{document}
%   - where appropriate put:
%     \bibliography{bib}
%
% - In chapter files put:
%   \IfNotCompilingAll{\bibliography{bib}}
\bibliographystyle{ieeetr}

\newcommand\IfNotCompilingAll[1]{
    \ifx\CompilingAll\undefined
        #1
    \fi
}

\begin{document}

WARNING: Compile main.tex instead.

\end{document}
